<div class="container-fluid overflow-auto" style="height: 100vh">
  <div class="offcanvas-header">
    <div class="d-inline-flex align-items-center">
      <div class="d-flex flex-column">
        <h5 class="offcanvas-title">{{ car.make }} {{ car.model }}</h5>
        <h5 class="offcanvas-title">{{ car.vin }}</h5>
      </div>
      <button class="btn btn-primary ms-3" (click)="markDeposit()" *ngIf="car.deposits.length === 0   && userType === 'client'">Déposer</button>
      <button class="btn btn-primary ms-3" (click)="markPending()" *ngIf="car.deposits.length > 0 && car.deposits[0].state === 'ready' && userType === 'client'">Récupérer</button>
      <button class="btn btn-primary ms-3" (click)="markReceived()" *ngIf="car.deposits.length > 0 && car.deposits[0].state === 'deposit' && userType === 'res_atelier'">Receptionner</button>
      <button class="btn btn-primary ms-3" (click)="markReady()" *ngIf="car.deposits.length > 0 && car.deposits[0].state === 'received'  && userType === 'res_atelier'" [disabled]="!canCollect && !allPaid">Pret</button>
      <button class="btn btn-primary ms-3" (click)="markCollected()" *ngIf="car.deposits.length > 0 && car.deposits[0].state === 'pending'  && userType === 'res_atelier'">Sortie</button>
      <div>
        <span *ngIf="car.deposits.length > 0 && car.deposits[0].state === 'collected'">Vous pouvez recuperer votre voiture. Merci de votre confiance.</span>
        <span class="ms-3" *ngIf="!canCollect">Il reste des réparations à effectuer.</span>
        <span class="ms-3" *ngIf="!allPaid">Il reste des factures impayés.</span>
      </div>
      <!-- <button class="btn btn-outline-secondary ms-3">Factures</button> -->
    </div>
    <button
      type="button"
      class="btn-close text-reset"
      aria-label="Close"
      (click)="activeOffcanvas.dismiss('Cross click')"
      ngbAutofocus
    ></button>
  </div>
  <div class="offcanvas-body">
    <img src="../../assets/img/car_placeholder.jpg" alt="card-pic" class="card-img-top" />
    <div class="my-3">
      <ngb-accordion #acc="ngbAccordion">
        <ngb-panel>
          <ng-template ngbPanelTitle>
            <div>
              <span class="offcanvas-title">Réparations</span>
              <span class="badge text-bg-danger ms-1">{{
                sortedRepairs.length
              }}</span>
            </div>
          </ng-template>
          <ng-template ngbPanelContent *ngIf="sortedRepairs.length > 0">
            <p class="mt-1 mb-0">
              <ngb-progressbar
                type="danger"
                [value]="repairAdv"
                [max]="100"
                [striped]="true"
                [animated]="true"
                height="15px"
              ></ngb-progressbar>
            </p>
            <table
              matSort
              (matSortChange)="sortRep($event)"
              class="table table-striped"
            >
              <thead>
                <tr>
                  <th mat-sort-header="name">Description</th>
                  <th mat-sort-header="state">Avancement</th>
                  <th mat-sort-header="amount">Montant</th>
                  <th mat-sort-header="payment">Etat</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let repair of sortedRepairs">
                  <td>{{ repair.name }}</td>
                  <td>{{ repair.state | repairState }}</td>
                  <td>{{ repair.amount | ariary }}</td>
                  <td>{{ repair.payment | paymentState }}</td>
                  <td>
                    <button class="btn btn-secondary"  (click)="markDone(repair)" *ngIf="repair.state === 'in_progress'  && userType === 'res_atelier'">Terminé</button>
                    <button class="btn btn-secondary"  (click)="markPaid(repair)" *ngIf="repair.payment === 'pending' && userType === 'res_finance'">Payé</button>
                    <button class="btn btn-primary"  (click)="markInProgress(repair)" *ngIf="repair.state === 'todo'  && userType === 'res_atelier'">Commencé</button>
                    <!-- <button class="btn btn-primary"  (click)="markCancelled(repair)">Annuler</button> -->
                  </td>
                </tr>
              </tbody>
            </table>
          </ng-template>
        </ngb-panel>
        <ngb-panel>
          <ng-template ngbPanelTitle>
            <div>
              <span class="offcanvas-title">Entretiens</span>
              <span class="badge text-bg-warning ms-1">{{
                sortedMaintenances.length
              }}</span>
            </div>
          </ng-template>
          <ng-template ngbPanelContent *ngIf="sortedMaintenances.length > 0">
            <p class="mt-1 mb-0">
              <ngb-progressbar
                type="warning"
                [value]="maintenanceAdv"
                [max]="100"
                [striped]="true"
                [animated]="true"
                height="15px"
              ></ngb-progressbar>
            </p>
            <table
              matSort
              (matSortChange)="sortMain($event)"
              class="table table-striped"
            >
              <thead>
                <tr>
                  <th mat-sort-header="name">Description</th>
                  <th mat-sort-header="state">Avancement</th>
                  <th mat-sort-header="amount">Montant</th>
                  <th mat-sort-header="payment">Etat</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let repair of sortedMaintenances">
                  <td>{{ repair.name }}</td>
                  <td>{{ repair.state | repairState }}</td>
                  <td>{{ repair.amount | ariary }}</td>
                  <td>{{ repair.payment | paymentState }}</td>
                  <td>
                    <button class="btn btn-secondary"  (click)="markDone(repair)" *ngIf="repair.state === 'in_progress'  && userType === 'res_atelier'">Terminé</button>
                    <button class="btn btn-secondary"  (click)="markPaid(repair)" *ngIf="repair.payment === 'pending' && userType === 'res_finance'">Payé</button>
                    <button class="btn btn-primary"  (click)="markInProgress(repair)" *ngIf="repair.state === 'todo'  && userType === 'res_atelier'">Commencé</button>
                    <!-- <button class="btn btn-primary"  (click)="markCancelled(repair)">Annuler</button> -->
                  </td>
                </tr>
              </tbody>
            </table>
          </ng-template>
        </ngb-panel>
        <ngb-panel>
          <ng-template ngbPanelTitle>
            <div>
              <span class="offcanvas-title">Diagnostiques</span>
              <span class="badge text-bg-info ms-1">{{
                sortedDiags.length
              }}</span>
            </div>
          </ng-template>
          <ng-template ngbPanelContent *ngIf="sortedDiags.length > 0">
            <p class="mt-1 mb-0">
              <ngb-progressbar
                type="info"
                [value]="diagAdv"
                [max]="100"
                [striped]="true"
                [animated]="true"
                height="15px"
              ></ngb-progressbar>
            </p>
            <table
              matSort
              (matSortChange)="sortDiag($event)"
              class="table table-striped"
            >
              <thead>
                <tr>
                  <th mat-sort-header="name">Description</th>
                  <th mat-sort-header="state">Avancement</th>
                  <th mat-sort-header="amount">Montant</th>
                  <th mat-sort-header="payment">Etat</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let repair of sortedDiags">
                  <td>{{ repair.name }}</td>
                  <td>{{ repair.state | repairState }}</td>
                  <td>{{ repair.amount | ariary }}</td>
                  <td>{{ repair.payment | paymentState }}</td>
                  <td>
                    <button class="btn btn-secondary"  (click)="markDone(repair)" *ngIf="repair.state === 'in_progress'  && userType === 'res_atelier'">Terminé</button>
                    <button class="btn btn-secondary"  (click)="markPaid(repair)" *ngIf="repair.payment === 'pending' && userType === 'res_finance'">Payé</button>
                    <button class="btn btn-primary"  (click)="markInProgress(repair)" *ngIf="repair.state === 'todo'  && userType === 'res_atelier'">Commencé</button>
                    <!-- <button class="btn btn-primary"  (click)="markCancelled(repair)">Annuler</button> -->
                  </td>
                </tr>
              </tbody>
            </table>
          </ng-template>
        </ngb-panel>
      </ngb-accordion>
    </div>
  </div>
  <div class="offcanvas-footer p-3">
    <button class="btn btn-secondary"
      (click)="open(repair)"
      *ngIf="car.deposits.length > 0 && car.deposits[0].state === 'received' && userType === 'res_atelier'">Ajouter travaux</button>
  </div>
</div>

<ng-template #repair let-modal>
	<div class="modal-header">
		<h4 class="modal-title" id="modal-basic-title">Ajouter une réparation</h4>
		<button type="button" class="btn-close" aria-label="Close" (click)="modal.dismiss('Cross click')"></button>
	</div>
	<div class="modal-body">
		<form #newRepair="ngForm" (ngSubmit)="submitRepair()">
      <div class="form-group mt-3">
        <label for="type">Type</label>
        <select class="form-select" name="type" aria-label="type" #typeField="ngModel" [(ngModel)]="addRepair.type" id="type" placeholder="Type de réparation" required>
          <option value="repair" selected>Réparation</option>
          <option value="maintenance">Entretien</option>
          <option value="diagnostic">Diagnostique</option>
        </select>
        <div *ngIf="!typeField.valid && typeField.touched">
          <small *ngIf="typeField.errors?.['required']">La marque est requise.</small>
        </div>
      </div>
      <div class="form-group mt-3">
        <label for="name">Nom</label>
        <input #nameField="ngModel" type="text" class="form-control" id="name" aria-describedby="name" placeholder="Tapez le nom de cette réparation" required
          [(ngModel)]="addRepair.name" name="name"/>
        <div *ngIf="!nameField.valid && nameField.touched">
          <small *ngIf="nameField.errors?.['required']">Le nom est requis.</small>
        </div>
      </div>
      <div class="form-group mt-3">
        <label for="amount">Cout</label>
        <input #amountField="ngModel" type="number" class="form-control" id="amount" aria-describedby="amount" placeholder="Tapez le cout de cette réparation" required
          [(ngModel)]="addRepair.amount" name="amount"/>
        <div *ngIf="!amountField.valid && amountField.touched">
          <small *ngIf="amountField.errors?.['required']">Le cout est requis.</small>
        </div>
      </div>
      <button
          type="submit"
          class="btn btn-secondary mt-3"
          [disabled]="!newRepair.form.valid"
        >
          Ajouter
      </button>
		</form>
	</div>
</ng-template>
<ngx-spinner type="square-jelly-box"></ngx-spinner>
